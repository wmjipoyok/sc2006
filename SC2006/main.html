<!DOCTYPE html>
<!--
 @license
 Copyright 2019 Google LLC. All Rights Reserved.
 SPDX-License-Identifier: Apache-2.0
-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Map</title>

    <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script> -->
    <!-- jsFiddle will insert css and js -->
    <link rel="stylesheet" type="text/css" href="./css/styles.css" />
    <script src="./js/common.js"></script>

    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWCnWvnjeAk5IAR910vcq5BuAs7xqRiO0&callback=initMap"
        defer></script>
    <script src="./js/svy21.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>

<body id="page-top">
    <div id="wrapper">
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content" style="width:100%; height:900px;">
                <div id="nav-content"></div>
                <div class="container-fluid">
                    <h4>Choose a car park to start renting cars</h4>
                    <div id="map" style="width: 100%; height: 750px"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Logout Modal-->
    <div id="logout-model"></div>

    <!-- <h4>Please choose a carpark to start renting cars</h4> -->
    <!-- <div id="map"></div> -->

    <!--The div element for the map -->

    <script>
        $(function () {
            $("#nav-content").load("nav.html");
            $("#logout-model").load("logout-model.html");
        });
        var cv = new SVY21();
        var prev_infowindow = false;

        getData();
        // Initialize and add the map
        let infoWindow, marker, map;
        function initMap() {
            // The location of sg (default value if fail to retrieve user's location)
            // const sg = { lat: 1.3318066965765096, lng: 103.71498878810786 };
            const sg = { lat: 1.3483, lng: 103.6831 }; // ntu location
            // The map, centered to sg by default
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15, //was 19
                center: sg,
                zoomControl: true,
            });

            infoWindow = new google.maps.InfoWindow();

            addMarker(1.3483, 103.6831);

            //get user currect location
            // if (navigator.geolocation) {
            //     navigator.geolocation.getCurrentPosition(
            //         (position) => {
            //             const pos = {
            //                 lat: position.coords.latitude,
            //                 lng: position.coords.longitude,
            //             };

            //             //set user's locaton to the map center & add the red market to the map
            //             map.setCenter(pos);
            //             addMarker(position.coords.latitude, position.coords.longitude);
            //         },
            //         () => {
            //             handleLocationError(true, infoWindow, map.getCenter());
            //         }
            //     );
            // } else {
            //     // Browser doesn't support Geolocation
            //     handleLocationError(false, infoWindow, map.getCenter());
            // }
        }

        //for center red marker
        function addMarker(lat, lng) {
            var marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
            });
        }

        //for carpark marker
        function addCarparkMarker(lat, lng, data) {
            const iconImg = {
                url: "../img/carpark-marker.png",
                scaledSize: new google.maps.Size(50, 40), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            }

            var marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                icon: iconImg,
            });

            const contentString = `Name: ${titleize(data["ppName"])} 
                                    <div style="margin-top: 5px;"><a href="#" class="btn btn-info btn-sm">
                                        <span class="text">View Car List</span></div>`;

            const infowindow = new google.maps.InfoWindow({
                content: contentString,
                ariaLabel: "car park",
            });

            marker.addListener("click", () => {
                if (prev_infowindow) {
                    prev_infowindow.close();
                }
                prev_infowindow = infowindow;
                infowindow.open({
                    anchor: marker,
                    map,
                });
            });
        }



        //handle get user location fail
        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(
                browserHasGeolocation
                    ? "Error: The Geolocation service failed."
                    : "Error: Your browser doesn't support geolocation."
            );
            infoWindow.open(map);
        }

        //api call to get car park info list
        function getData() {
            // if u wanna access the api, search "Run" in your laptop and run the code below:
            // "chrome.exe --user-data-dir="C:/Chrome dev session" --disable-web-security"
            // then go to http://localhost:5000

            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4 && this.status == 200) {
                    const resultJson = JSON.parse(this.responseText);
                    // console.log(resultJson);
                    var coordinate;
                    var preCoor;
                    for (var i in resultJson.Result) {
                        if (resultJson.Result[i].geometries[0]) {
                            coordinate = resultJson.Result[i].geometries[0].coordinates;
                            if (coordinate) {
                                if (preCoor == coordinate) {
                                    continue;
                                } else {
                                    preCoor = coordinate;
                                }

                                var strArr = coordinate.split(",")
                                var latlng = cv.computeLatLon(strArr[1], strArr[0]);
                                addCarparkMarker(latlng.lat, latlng.lon, resultJson.Result[i]);
                            }
                        }
                    }
                }
            });

            xhr.open("GET", "https://www.ura.gov.sg/uraDataService/invokeUraDS?service=Car_Park_Details");
            xhr.setRequestHeader("AccessKey", "d42d13f1-6cfa-489b-9940-508afe48dcf8");
            xhr.setRequestHeader("Token", "6-8yd44Hs3T89-q7CzHQccBw44gmdHcb9-Qgdsac9fSJJayxg-kp4MHf7kBN8s8K-dA88+pNkTm98Fcf4@Yf9ccqNd040aJe18+c");

            xhr.send();
        }

        window.initMap = initMap;


    </script>
</body>

</html>