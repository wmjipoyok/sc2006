<!DOCTYPE html>
<!--
 @license
 Copyright 2019 Google LLC. All Rights Reserved.
 SPDX-License-Identifier: Apache-2.0
-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Map</title>

    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <!-- jsFiddle will insert css and js -->
    <link rel="stylesheet" type="text/css" href="./css/styles.css" />
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <script src="./js/common.js"></script>
</head>

<body>
    <div id="content">
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a href="profile.html" class="nav-link"><span
                            class="mr-2 d-none d-lg-inline text-gray-600 small">Profile</span>
                        <img class="img-profile rounded-circle" src="img/profile.png">
                    </a>
                </li>
                <!-- Can add more links here for extensibility to more pages next time -->
            </ul>
        </nav>
    </div>

    <h4>Please choose a carpart to start renting cars</h3>
        <!--The div element for the map -->
        <div id="map"></div>


        <!-- 
      The `defer` attribute causes the callback to execute after the full HTML
      document has been parsed. For non-blocking uses, avoiding race conditions,
      and consistent behavior across browsers, consider loading using Promises
      with https://www.npmjs.com/package/@googlemaps/js-api-loader.
      -->
        <script async
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWCnWvnjeAk5IAR910vcq5BuAs7xqRiO0&callback=initMap"
            defer></script>
        <script src="./js/svy21.js"></script>
        <script>
            var cv = new SVY21();
            var prev_infowindow = false;

            getData();
            // Initialize and add the map
            let infoWindow, marker, map;
            function initMap() {
                // The location of sg (default value if fail to retrieve user's location)
                const sg = { lat: 1.3318066965765096, lng: 103.71498878810786 };
                // The map, centered to sg by default
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15, //was 19
                    center: sg,
                    zoomControl: true,
                });

                infoWindow = new google.maps.InfoWindow();

                //get user currect location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };

                            //set user's locaton to the map center & add the red market to the map
                            map.setCenter(pos);
                            addMarker(position.coords.latitude, position.coords.longitude);
                        },
                        () => {
                            handleLocationError(true, infoWindow, map.getCenter());
                        }
                    );
                } else {
                    // Browser doesn't support Geolocation
                    handleLocationError(false, infoWindow, map.getCenter());
                }
            }

            //for center red marker
            function addMarker(lat, lng) {
                var marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                });
            }

            //for carpark marker
            function addCarparkMarker(lat, lng, data) {
                const iconImg = {
                    url: "../img/carpark-marker.png",
                    scaledSize: new google.maps.Size(50, 40), // scaled size
                    origin: new google.maps.Point(0, 0), // origin
                    anchor: new google.maps.Point(0, 0) // anchor
                }

                var marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    icon: iconImg,
                });

                const contentString = `Name: ${titleize(data["ppName"])}`;

                const infowindow = new google.maps.InfoWindow({
                    content: contentString,
                    ariaLabel: "car park",
                });

                marker.addListener("click", () => {
                    if (prev_infowindow) {
                        prev_infowindow.close();
                    }
                    prev_infowindow = infowindow;
                    infowindow.open({
                        anchor: marker,
                        map,
                    });
                });
            }



            //handle get user location fail
            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPosition(pos);
                infoWindow.setContent(
                    browserHasGeolocation
                        ? "Error: The Geolocation service failed."
                        : "Error: Your browser doesn't support geolocation."
                );
                infoWindow.open(map);
            }

            //api call to get car park info list
            function getData() {
                // if u wanna access the api, search "Run" in your laptop and run the code below:
                // "chrome.exe --user-data-dir="C:/Chrome dev session" --disable-web-security"
                // then go to http://localhost:5000

                var xhr = new XMLHttpRequest();
                xhr.withCredentials = true;

                xhr.addEventListener("readystatechange", function () {
                    if (this.readyState === 4 && this.status == 200) {
                        const resultJson = JSON.parse(this.responseText);
                        // console.log(resultJson);
                        var coordinate;
                        var preCoor;
                        for (var i in resultJson.Result) {
                            if (resultJson.Result[i].geometries[0]) {
                                coordinate = resultJson.Result[i].geometries[0].coordinates;
                                if (coordinate) {
                                    if (preCoor == coordinate) {
                                        continue;
                                    } else {
                                        preCoor = coordinate;
                                    }

                                    var strArr = coordinate.split(",")
                                    var latlng = cv.computeLatLon(strArr[1], strArr[0]);
                                    addCarparkMarker(latlng.lat, latlng.lon, resultJson.Result[i]);
                                }
                            }
                        }
                    }
                });

                xhr.open("GET", "https://www.ura.gov.sg/uraDataService/invokeUraDS?service=Car_Park_Details");
                xhr.setRequestHeader("AccessKey", "d42d13f1-6cfa-489b-9940-508afe48dcf8");
                xhr.setRequestHeader("Token", "-PFf3ef9zNu98+g3P9m88j09f4hsBqF8d98w19XT67s6dRw24R9-fSe44-60dd6zju9pEDW6dkrR@4Q-E-5WkQYNXQEb95f288fM");

                xhr.send();
            }

            window.initMap = initMap;


        </script>
</body>

</html>