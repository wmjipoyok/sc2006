<!DOCTYPE html>
<!--
 @license
 Copyright 2019 Google LLC. All Rights Reserved.
 SPDX-License-Identifier: Apache-2.0
-->
<html>

<head>
    <title>Map</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <!-- jsFiddle will insert css and js -->
    <link rel="stylesheet" type="text/css" href="./css/styles.css" />
</head>

<body>
    <h3>Please choose a carpart to start renting cars</h3>
    <!--The div element for the map -->
    <div id="map"></div>

    <!-- 
      The `defer` attribute causes the callback to execute after the full HTML
      document has been parsed. For non-blocking uses, avoiding race conditions,
      and consistent behavior across browsers, consider loading using Promises
      with https://www.npmjs.com/package/@googlemaps/js-api-loader.
      -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWCnWvnjeAk5IAR910vcq5BuAs7xqRiO0&callback=initMap"
        defer></script>
    <script src="./js/svy21.js"></script>
    <script>
        var cv = new SVY21();
        var coorArr = [];

        getData();
        // Initialize and add the map
        let infoWindow, marker, map;
        function initMap() {
            // The location of sg
            const sg = { lat: 1.3472892422936993, lng: 103.68084315437358 };
            // The map, centered at sg
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 19,
                center: sg,
                zoomControl: true,
                // gestureHandling: "cooperative",
            });
            var currentLocatoin = { lat: 1.3472892422936993, lng: 103.68084315437358 };
            infoWindow = new google.maps.InfoWindow();

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        // infoWindow.setPosition(pos);
                        // infoWindow.setContent("Location found.");
                        // infoWindow.open(map);
                        map.setCenter(pos);
                        addMarker(position.coords.latitude, position.coords.longitude);
                    },
                    () => {
                        handleLocationError(true, infoWindow, map.getCenter());
                    }
                );
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        }

        function addMarker(lat, lng) {
            var marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
            });
        }

        function addCarparkMarker(lat, lng) {
            const iconImg = {
                url: "../img/carpark-marker.png",
                scaledSize: new google.maps.Size(50, 40), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            }
            var marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                icon: iconImg,
            });
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(
                browserHasGeolocation
                    ? "Error: The Geolocation service failed."
                    : "Error: Your browser doesn't support geolocation."
            );
            infoWindow.open(map);
        }

        function getData() {
            // if u wanna access the api, search "Run" in your laptop and run the code below:
            // "chrome.exe --user-data-dir="C:/Chrome dev session" --disable-web-security"
            // then go to http://localhost:5000

            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4 && this.status == 200) {
                    const resultJson = JSON.parse(this.responseText);
                    // console.log(resultJson);
                    var coordinate;
                    var preCoor;
                    for (var i in resultJson.Result) {
                        if (resultJson.Result[i].geometries[0]) {
                            coordinate = resultJson.Result[i].geometries[0].coordinates;
                            if (coordinate) {
                                if (preCoor == coordinate) {
                                    continue;
                                } else {
                                    coorArr.push(coordinate);
                                    preCoor = coordinate;
                                }

                                var strArr = coordinate.split(",")
                                var latlng = cv.computeLatLon(strArr[0], strArr[1]);
                                addCarparkMarker(latlng.lat, latlng.lon);

                            }
                        }
                    }
                }
                // for (var i in coorArr) {
                //     // console.log(coorArr[i]);
                //     convertToLatLng(coorArr[i]);
                // }
            });

            xhr.open("GET", "https://www.ura.gov.sg/uraDataService/invokeUraDS?service=Car_Park_Details");
            xhr.setRequestHeader("AccessKey", "d42d13f1-6cfa-489b-9940-508afe48dcf8");
            xhr.setRequestHeader("Token", "NfEqcdd8f+XdfN4jzjj9yd90955H4fjeMGD8B88NEa6vBAp80464wfe98-d2NSC-qztR6kzMnQvbmB45dP3CfPZ-dJYa8DBG-U+x");

            xhr.send();
        }

        function convertToLatLng(coor) {
            console.log(coor);
            var strArr = coor.split(",");
            // var xhr = new XMLHttpRequest();

            // xhr.addEventListener("readystatechange", function () {
            //     if (this.readyState === 4 && this.status == 200) {
            //         const resultJson = JSON.parse(this.responseText);
            //         console.log(resultJson);
            //         // addCarparkMarker(latlng.lat, latlng.lon);
            //     }
            // });

            // xhr.open("GET", `https://developers.onemap.sg/commonapi/convert/3857to4326?Y=${strArr[1]}&X=${strArr[0]}`);
            // xhr.send();
        }


        window.initMap = initMap;


    </script>
</body>

</html>