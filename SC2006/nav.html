<!-- Bootstrap core JavaScript-->

<head>
    <script src="./vendor/jquery/jquery.min.js"></script>
    <script src="./vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="./vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="js/sb-admin-2.min.js"></script>
    <link href="./vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="./css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./css/styles.css" />
    <script src="./js/common.js"></script>
    <!-- <script type="module" src="./js/message.js"></script> -->

    <script src="/__/firebase/9.17.1/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.17.1/firebase-auth-compat.js">//important</script>
    <script src="/__/firebase/9.17.1/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/9.17.1/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/9.17.1/firebase-storage-compat.js"></script>
    <script src="/__/firebase/init.js?useEmulator=true"></script>
</head>

<nav class="navbar navbar-expand navbar-light bg-white topbar mb-3 static-top shadow">
    <li class="nav-item mx-1">
        <a class="nav-link" aria-current="page" href="main.html" id="logo">
            <img src="./img/logo.png" style="width: 90px;">
        </a>
    </li>
    <ul class="navbar-nav ml-auto">
        <!-- Nav Item - Alerts -->
        <li class="nav-item dropdown no-arrow mx-1">
            <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button" data-toggle="dropdown"
                onclick="handleAlertCount()" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-bell fa-fw"></i>
                <!-- Counter - Alerts -->
                <span class="badge badge-danger badge-counter" id="notiCount" style="visibility: hidden;">0</span>
            </a>
            <!-- Dropdown - Alerts -->
            <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                aria-labelledby="alertsDropdown">
                <h6 class="dropdown-header">
                    Messages Center
                </h6>
                <div id="alertContainer"></div>
                <!-- <a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a> -->
                <div class="text-center small text-gray-500" style="padding-top: 10px; padding-bottom: 10px;"
                    id="noAlert">
                    No Messages
                </div>
            </div>
        </li>

        <div class="topbar-divider d-none d-sm-block"></div>

        <li class="nav-item dropdown no-arrow mx-1">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <span id="nav-name" class="mr-2 d-none d-lg-inline text-gray-600 small"></span>
                <img class="img-profile rounded-circle" src="img/profile.png">
            </a>

            <!-- Dropdown - User Information -->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                <a class="dropdown-item" href="profile.html">
                    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                    Profile
                </a>
                <a class="dropdown-item" href="bookings.html">
                    <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                    Bookings
                </a>
                <a class="dropdown-item" href="help-center.html">
                    <i class="fas fa-info-circle fa-sm fa-fw mr-2 text-gray-400"></i>
                    Help Center
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                    Logout
                </a>
            </div>
        </li>
        <!-- Can add more links here for extensibility to more pages next time -->
    </ul>
</nav>

<script type="module">
    import { } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-messaging.js";

    requestPermission();

    function requestPermission() {
        // console.log('Requesting permission...');
        Notification.requestPermission().then((permission) => {
            if (permission === 'granted') {
                // console.log('Notification permission granted.');x
                messaging.getToken({ vapidKey: 'BIKm-OqsfzgKZhCH9oczK00Gq8gHLwLzvSKlrD3H1A0FuNKZW3x-D9xPoRbNbpnRTbVW5XL7c9AJVODdoV_pLAI' })
                    .then((currentToken) => {
                        if (currentToken) {
                            localStorage.setItem("currToken", currentToken);
                        } else {
                            console.log("cannot get notification token");
                        }
                    })
                    .catch((err) => {
                        console.log('An error occurred while retrieving token. ', err);
                    });
            } else {
                console.log("do not have permission");
            }
        })
    }


    messaging.onMessage((payload) => {
        console.log('Message received. ', payload);
        const userId = localStorage.getItem("userId");
        const notiCount = document.getElementById('notiCount');
        if ((userId == payload.data.receiverId) && notiCount) {
            if (notiCount) {
                if (notiCount.style.visibility == 'hidden') {
                    notiCount.style.visibility = 'visible';
                }
                notiCount.innerHTML = parseInt(notiCount.innerHTML) + 1;
                const alerts = document.getElementById('alertContainer');
                const carId = payload.data.carId;
                var currentdate = new Date();
                alerts.innerHTML += `<a class="dropdown-item d-flex align-items-center" href="car-detail.html?carId=${carId}">
            <div class="mr-3">
                <div class="icon-circle bg-primary">
                    <i class="fas fa-file-alt text-white"></i>
                </div>
            </div>
            <div>
                <div class="small text-gray-500">${currentdate.toLocaleString("fr-ca")} ${currentdate.toLocaleTimeString('it-IT')}</div>
                <span class="font-weight-bold">${payload.data.message}</span>
            </div>
        </a>`

            }

        }
    });
</script>

<script>
    const db = firebase.firestore();

    //get user's ID
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            // User is signed in.
            const userID = user.uid;
            //console.log("UID: ", userID); DEBUG

            //get user's doc from "Users" collection
            db.collection("Users").doc(userID).get().then((doc) => {
                if (doc.exists) {
                    //retrieve user data from doc
                    const userData = doc.data();
                    const firstName = userData.FirstName;

                    //update DOM with retrieved data
                    document.getElementById("nav-name").innerHTML = firstName;
                } else {
                    console.log("No such document!", doc);
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });

            db.collection("Messages").where("ReceiverId", "==", userID).get()
                .then((msgSnapshot) => {
                    const msgDocs = msgSnapshot.docs; //need js array since the snapshot does not have a index for forEach 
                    msgDocs.forEach((doc, index) => {
                        const alerts = document.getElementById('alertContainer');
                        alerts.innerHTML += `<a class="dropdown-item d-flex align-items-center" href="car-detail.html?carId=${doc.data().CarId}">
                            <div class="mr-3">
                                <div class="icon-circle bg-primary">
                                    <i class="fas fa-envelope text-white"></i>
                                </div>
                            </div>
                            <div>
                                <div class="small text-gray-500">${doc.data().DateTime}</div>
                                <span class="font-weight-bold">${doc.data().Message}</span>
                            </div>
                        </a>`
                    });
                }).catch((error) => {
                    console.log("Error getting document:", error);
                });
        }
        else {
            // User is signed out.
            console.log(firebase.auth().currentUser);
        }
    })
</script>